<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zohar AI — Sacred Text & Teachings</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=Noto+Serif+Hebrew:wght@300;400&display=swap" rel="stylesheet">
<script src="data_english.js"></script>
<script src="data_aramaic.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px}
body{font-family:'EB Garamond',Georgia,serif;background:#fff;color:#1a1a1a;min-height:100vh;display:flex;flex-direction:column}
.site-header{border-bottom:1px solid #e0e0e0;padding:0 40px;background:#fff;position:sticky;top:0;z-index:200}
.header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px}
.site-logo{font-family:'Playfair Display',Georgia,serif;font-size:1.6rem;font-weight:700;color:#1a1a1a;letter-spacing:.04em;text-decoration:none}
.site-logo em{color:#c0392b;font-style:normal}
.header-nav{display:flex;gap:32px;align-items:center}
.nav-link{font-family:'EB Garamond',serif;font-size:.95rem;letter-spacing:.08em;text-transform:uppercase;color:#444;text-decoration:none;transition:color .15s;cursor:pointer}
.nav-link:hover{color:#c0392b}
.nav-link.active{color:#c0392b;border-bottom:2px solid #c0392b;padding-bottom:2px}
.app-body{flex:1;display:flex;flex-direction:column;max-width:1200px;margin:0 auto;width:100%;padding:0 40px}
.mode-bar{display:flex;gap:0;border-bottom:2px solid #e0e0e0;margin-top:32px;margin-bottom:28px}
.mode-tab{background:none;border:none;font-family:'EB Garamond',serif;font-size:1rem;letter-spacing:.1em;text-transform:uppercase;color:#888;padding:10px 28px 10px 0;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.mode-tab:hover{color:#333}
.mode-tab.active{color:#c0392b;border-bottom-color:#c0392b;font-weight:500}
.browse-view{display:none;flex-direction:column;flex:1}
.browse-view.active{display:flex}
.browse-top{display:flex;gap:16px;align-items:center;margin-bottom:24px;flex-wrap:wrap}
.browse-search-wrap{flex:1;min-width:240px}
.browse-search-wrap input{width:100%;border:1px solid #d0d0d0;border-radius:2px;font-family:'EB Garamond',serif;font-size:1rem;padding:9px 14px;outline:none;color:#1a1a1a;transition:border-color .15s}
.browse-search-wrap input:focus{border-color:#c0392b}
.browse-search-wrap input::placeholder{color:#aaa;font-style:italic}
.filter-select{border:1px solid #d0d0d0;border-radius:2px;font-family:'EB Garamond',serif;font-size:.95rem;padding:9px 14px;color:#444;background:#fff;cursor:pointer;outline:none}
.filter-select:focus{border-color:#c0392b}
.para-num-input{width:100px;border:1px solid #d0d0d0;border-radius:2px;font-family:'EB Garamond',serif;font-size:1rem;padding:9px 12px;text-align:center;outline:none;color:#1a1a1a}
.para-num-input::placeholder{color:#aaa;font-style:italic;font-size:.85rem}
.browse-results-meta{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid #e8e8e8}
.browse-results-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:400;color:#1a1a1a}
.browse-results-count{font-size:.85rem;color:#888}
.browse-results-count strong{color:#c0392b}
.para-row{display:grid;grid-template-columns:1fr 1fr;border:1px solid #e0e0e0;border-radius:2px;margin-bottom:12px;overflow:hidden;transition:border-color .15s}
.para-row:hover{border-color:#c0392b}
.para-row-header{grid-column:1/-1;background:#fafafa;border-bottom:1px solid #e8e8e8;padding:8px 18px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.para-row-ref{font-size:.78rem;text-transform:uppercase;letter-spacing:.15em;color:#c0392b}
.para-row-toggle{font-size:.75rem;color:#aaa;transition:transform .15s}
.para-row.open .para-row-toggle{transform:rotate(180deg)}
.para-row-preview{grid-column:1/-1;padding:10px 18px;font-style:italic;color:#888;font-size:.95rem;cursor:pointer}
.para-row.open .para-row-preview{display:none}
.para-col{display:none;padding:20px 22px 24px}
.para-row.open .para-col{display:block}
.para-col-english{border-right:1px solid #e8e8e8}
.para-col-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.2em;color:#c0392b;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.english-body{font-size:1rem;line-height:1.85;color:#1a1a1a}
.ashlag-text{color:#c0392b}
.aramaic-body{font-family:'Noto Serif Hebrew','Times New Roman',serif;font-size:1.1rem;line-height:2;direction:rtl;text-align:right;color:#1a1a1a}
.copy-btn{background:none;border:1px solid #d0d0d0;color:#888;font-family:'EB Garamond',serif;font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;padding:2px 8px;cursor:pointer;border-radius:2px;transition:all .15s}
.copy-btn:hover{border-color:#c0392b;color:#c0392b}
.browse-empty{text-align:center;padding:80px 20px;color:#aaa;font-style:italic;font-size:1.05rem}
.pagination{display:flex;justify-content:center;gap:6px;margin:32px 0 48px;flex-wrap:wrap}
.page-btn{background:#fff;border:1px solid #d0d0d0;color:#666;font-family:'EB Garamond',serif;font-size:.9rem;padding:5px 14px;cursor:pointer;border-radius:2px;transition:all .12s}
.page-btn:hover,.page-btn.active{border-color:#c0392b;color:#c0392b;background:#fff8f7}
mark{background:#fff3cd;color:#1a1a1a;border-radius:2px;padding:0 2px}
.chat-view{display:none;flex-direction:column;flex:1}
.chat-view.active{display:flex}
.chat-layout{display:flex;flex:1;border:1px solid #e0e0e0;border-radius:2px;overflow:hidden}
.portions-sidebar{width:220px;min-width:220px;border-right:1px solid #e0e0e0;overflow-y:auto;background:#fafafa}
.sidebar-heading{font-size:.68rem;text-transform:uppercase;letter-spacing:.2em;color:#888;padding:16px 16px 8px;border-bottom:1px solid #e8e8e8}
.vol-group{border-bottom:1px solid #e8e8e8}
.vol-header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;cursor:pointer;font-size:.82rem;font-weight:500;color:#444;transition:background .1s}
.vol-header:hover{background:#f0f0f0}
.vol-header.open{color:#c0392b}
.vol-arrow{font-size:.65rem;color:#bbb;transition:transform .15s}
.vol-header.open .vol-arrow{transform:rotate(180deg);color:#c0392b}
.vol-portions{display:none}
.vol-header.open+.vol-portions{display:block}
.portion-link{display:block;padding:6px 16px 6px 24px;font-size:.82rem;font-style:italic;color:#666;cursor:pointer;transition:all .1s}
.portion-link:hover{background:#f0f0f0;color:#c0392b}
.portion-link.active{color:#c0392b;background:#fff0ee;font-weight:500}
.chat-main{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-messages{flex:1;overflow-y:auto;padding:28px 32px;display:flex;flex-direction:column;gap:24px;min-height:400px;max-height:calc(100vh - 280px)}
.chat-welcome{text-align:center;padding:48px 20px 32px}
.welcome-title{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:400;color:#1a1a1a;margin-bottom:10px}
.welcome-sub{font-style:italic;color:#888;font-size:1rem;line-height:1.7;max-width:500px;margin:0 auto 24px}
.suggestion-chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.chip{border:1px solid #d0d0d0;border-radius:20px;padding:6px 18px;font-family:'EB Garamond',serif;font-style:italic;font-size:.92rem;color:#555;cursor:pointer;transition:all .15s;background:#fff}
.chip:hover{border-color:#c0392b;color:#c0392b;background:#fff8f7}
.msg{display:flex;flex-direction:column;gap:4px;animation:fadeUp .25s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg.user{align-items:flex-end}
.msg.assistant{align-items:flex-start}
.msg-bubble{max-width:80%;padding:12px 18px;border-radius:2px;font-size:1rem;line-height:1.75}
.msg.user .msg-bubble{background:#fff8f7;border:1px solid #e8c8c4;color:#1a1a1a;font-style:italic}
.msg.assistant .msg-bubble{background:#fafafa;border:1px solid #e0e0e0;color:#1a1a1a;max-width:95%}
.zohar-block{border:1px solid #e0d0c0;border-radius:2px;margin:14px 0;overflow:hidden;background:#fffdf9}
.zohar-block-ref{background:#fdf5ee;border-bottom:1px solid #e8ddd0;padding:7px 16px;font-size:.72rem;text-transform:uppercase;letter-spacing:.18em;color:#c0392b;display:flex;justify-content:space-between;align-items:center}
.zohar-block-body{display:grid;grid-template-columns:1fr 1fr}
.zohar-english-col{padding:16px 18px;border-right:1px solid #e8ddd0;font-size:.97rem;line-height:1.85;color:#1a1a1a}
.zohar-aramaic-col{padding:16px 18px;font-family:'Noto Serif Hebrew','Times New Roman',serif;font-size:1.05rem;line-height:2;direction:rtl;text-align:right;color:#1a1a1a}
.ai-commentary{font-style:italic;color:#555;font-size:.97rem;line-height:1.75;margin:8px 0}
.teaching-summary{background:#fff8f7;border:1px solid #e8c8c4;border-radius:2px;padding:14px 18px;margin-top:16px}
.teaching-summary-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.18em;color:#c0392b;margin-bottom:8px}
.teaching-summary-text{font-size:.97rem;line-height:1.75;color:#333}
.practical-prompt{margin-top:12px;padding-top:12px;border-top:1px solid #e8d0cc;font-style:italic;color:#c0392b;font-size:.95rem;cursor:pointer}
.practical-prompt:hover{text-decoration:underline}
.thinking{display:flex;align-items:center;gap:10px;padding:8px 0}
.thinking-dots{display:flex;gap:4px}
.thinking-dot{width:5px;height:5px;border-radius:50%;background:#c0392b;opacity:.3;animation:tpulse 1.2s ease-in-out infinite}
.thinking-dot:nth-child(2){animation-delay:.2s}
.thinking-dot:nth-child(3){animation-delay:.4s}
@keyframes tpulse{0%,100%{opacity:.15;transform:scale(.8)}50%{opacity:.6;transform:scale(1)}}
.thinking-label{font-size:.82rem;font-style:italic;color:#aaa}
.chat-input-bar{border-top:1px solid #e0e0e0;padding:16px 24px;background:#fff;display:flex;flex-direction:column;gap:6px}
.chat-input-row{display:flex;gap:12px;align-items:flex-end}
.chat-textarea{flex:1;border:1px solid #d0d0d0;border-radius:2px;font-family:'EB Garamond',serif;font-size:1rem;padding:10px 14px;outline:none;resize:none;min-height:42px;max-height:120px;line-height:1.5;color:#1a1a1a;transition:border-color .15s}
.chat-textarea:focus{border-color:#c0392b}
.chat-textarea::placeholder{color:#aaa;font-style:italic}
.send-btn{background:#c0392b;border:none;color:#fff;font-family:'EB Garamond',serif;font-size:.95rem;letter-spacing:.06em;padding:10px 24px;cursor:pointer;border-radius:2px;transition:background .15s;flex-shrink:0}
.send-btn:hover:not(:disabled){background:#a93226}
.send-btn:disabled{background:#ddd;color:#aaa;cursor:not-allowed}
.chat-hint{font-size:.7rem;color:#bbb;font-style:italic;text-align:center}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#ddd;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#c0392b}
.site-footer{border-top:1px solid #e0e0e0;padding:20px 40px;text-align:center;font-size:.78rem;color:#aaa;font-style:italic;margin-top:auto}
@media(max-width:768px){.site-header,.app-body{padding-left:16px;padding-right:16px}.portions-sidebar{display:none}.para-row,.zohar-block-body{grid-template-columns:1fr}.para-col-english{border-right:none;border-bottom:1px solid #e8e8e8}.zohar-english-col{border-right:none;border-bottom:1px solid #e8ddd0}}
</style>
</head>
<body>
<header class="site-header">
  <div class="header-inner">
    <a class="site-logo" href="#">Zohar <em>AI</em></a>
    <nav class="header-nav">
      <a class="nav-link active" href="#" onclick="setMode('chat');return false">Teachings</a>
      <a class="nav-link" href="#" onclick="setMode('browse');return false">Browse</a>
    </nav>
  </div>
</header>
<div class="app-body">
  <div class="mode-bar">
    <button class="mode-tab active" id="tab-chat" onclick="setMode('chat')">AI Teachings</button>
    <button class="mode-tab" id="tab-browse" onclick="setMode('browse')">Browse Text</button>
  </div>
  <div class="chat-view active" id="chatView">
    <div class="chat-layout">
      <div class="portions-sidebar">
        <div class="sidebar-heading">Browse by Portion</div>
        <div id="portionsSidebar"></div>
      </div>
      <div class="chat-main">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-welcome" id="chatWelcome">
            <div class="welcome-title">Ask for a Teaching</div>
            <p class="welcome-sub">Ask any spiritual question and I will search the Zohar for the relevant passages, presenting only verbatim text from the source.</p>
            <div class="suggestion-chips">
              <div class="chip" onclick="sendChip(this)">The nature of the soul</div>
              <div class="chip" onclick="sendChip(this)">Light and darkness in Creation</div>
              <div class="chip" onclick="sendChip(this)">How to draw close to the Creator</div>
              <div class="chip" onclick="sendChip(this)">The Rose among thorns</div>
              <div class="chip" onclick="sendChip(this)">The meaning of Shabbat</div>
              <div class="chip" onclick="sendChip(this)">The secret of the letters</div>
            </div>
          </div>
        </div>
        <div class="chat-input-bar">
          <div class="chat-input-row">
            <textarea class="chat-textarea" id="chatInput" placeholder="Ask for a teaching or type a theme..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
          </div>
          <div class="chat-hint">All Zohar text is retrieved verbatim from source — nothing is generated or translated</div>
        </div>
      </div>
    </div>
  </div>
  <div class="browse-view" id="browseView">
    <div class="browse-top">
      <div class="browse-search-wrap">
        <input type="text" id="browseSearch" placeholder="Search by keyword or phrase..." oninput="onBrowseSearch()">
      </div>
      <select class="filter-select" id="filterVol" onchange="onBrowseSearch()"><option value="">All Volumes</option></select>
      <select class="filter-select" id="filterPortion" onchange="onBrowseSearch()"><option value="">All Portions</option></select>
      <input class="para-num-input" type="text" id="filterPara" placeholder="Para #" oninput="onBrowseSearch()">
    </div>
    <div id="browseResultsMeta" style="display:none" class="browse-results-meta">
      <div class="browse-results-title" id="browseTitle">Results</div>
      <div class="browse-results-count">Showing <strong id="browseCount">0</strong> paragraphs</div>
    </div>
    <div id="browseResults"><div class="browse-empty">Select a portion or search above to browse the text.</div></div>
    <div id="browsePagination" class="pagination"></div>
  </div>
</div>
<footer class="site-footer">All text presented verbatim from The Zohar &middot; Volumes I&ndash;XVI &middot; Translations by Kabbalah Centre</footer>
<script>
let mode='chat',browseResults=[],browsePage=1,isThinking=false;
const PAGE_SIZE=15;

function setMode(m){
  mode=m;
  document.getElementById('chatView').classList.toggle('active',m==='chat');
  document.getElementById('browseView').classList.toggle('active',m==='browse');
  document.getElementById('tab-chat').classList.toggle('active',m==='chat');
  document.getElementById('tab-browse').classList.toggle('active',m==='browse');
  document.querySelectorAll('.nav-link').forEach((l,i)=>l.classList.toggle('active',(i===0&&m==='chat')||(i===1&&m==='browse')));
}

function buildNav(){
  const volMap={};
  ENGLISH.forEach(p=>{if(!volMap[p.volume])volMap[p.volume]=[];if(!volMap[p.volume].includes(p.portion))volMap[p.volume].push(p.portion);});
  document.getElementById('portionsSidebar').innerHTML=Object.keys(volMap).sort((a,b)=>+a-+b).map(vol=>`<div class="vol-group"><div class="vol-header" onclick="this.classList.toggle('open')"><span>Volume ${vol}</span><span class="vol-arrow">▾</span></div><div class="vol-portions">${volMap[vol].map(p=>`<div class="portion-link" onclick="portionClick('${p.replace(/'/g,"\'")}',this)">${p}</div>`).join('')}</div></div>`).join('');
  const vs=document.getElementById('filterVol');
  Object.keys(volMap).sort((a,b)=>+a-+b).forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=`Volume ${v}`;vs.appendChild(o);});
  const ps=document.getElementById('filterPortion');
  [...new Set(ENGLISH.map(p=>p.portion))].forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;ps.appendChild(o);});
}

function portionClick(portion,el){
  document.querySelectorAll('.portion-link').forEach(l=>l.classList.remove('active'));
  el.classList.add('active');
  setMode('browse');
  document.getElementById('filterPortion').value=portion;
  onBrowseSearch();
}

function onBrowseSearch(){browsePage=1;runBrowse();}
function runBrowse(){
  const q=document.getElementById('browseSearch').value.trim().toLowerCase();
  const vol=parseInt(document.getElementById('filterVol').value);
  const portion=document.getElementById('filterPortion').value;
  const para=parseInt(document.getElementById('filterPara').value);
  browseResults=ENGLISH.filter(p=>{
    if(!isNaN(vol)&&p.volume!==vol)return false;
    if(portion&&p.portion!==portion)return false;
    if(!isNaN(para)&&p.paragraph_number!==para)return false;
    if(q&&!(p.english+' '+(p.ashlag_commentary||'')).toLowerCase().includes(q))return false;
    return true;
  });
  browseResults.sort((a,b)=>a.volume!==b.volume?a.volume-b.volume:a.portion!==b.portion?a.portion.localeCompare(b.portion):a.paragraph_number-b.paragraph_number);
  renderBrowse(q);
}
function renderBrowse(q){
  const container=document.getElementById('browseResults');
  const meta=document.getElementById('browseResultsMeta');
  const pag=document.getElementById('browsePagination');
  const total=browseResults.length;
  if(total===0){meta.style.display='none';container.innerHTML=`<div class="browse-empty">${q?'No paragraphs found.':'Select a portion or search above.'}</div>`;pag.innerHTML='';return;}
  meta.style.display='flex';
  document.getElementById('browseCount').textContent=total.toLocaleString();
  const portion=document.getElementById('filterPortion').value;
  const vol=document.getElementById('filterVol').value;
  document.getElementById('browseTitle').textContent=portion||(vol?`Volume ${vol}`:'All Results');
  const totalPages=Math.ceil(total/PAGE_SIZE);
  const items=browseResults.slice((browsePage-1)*PAGE_SIZE,browsePage*PAGE_SIZE);
  container.innerHTML=items.map(p=>renderParaRow(p,q)).join('');
  if(totalPages<=1){pag.innerHTML='';return;}
  let pages=[];
  for(let i=1;i<=totalPages;i++){if(i===1||i===totalPages||(i>=browsePage-2&&i<=browsePage+2))pages.push(i);else if(pages[pages.length-1]!=='...')pages.push('...');}
  pag.innerHTML=pages.map(p=>p==='...'?`<span style="color:#ccc;padding:4px">...</span>`:`<button class="page-btn ${p===browsePage?'active':''}" onclick="goPage(${p})">${p}</button>`).join('');
}
function renderParaRow(para,q){
  const araText=ARAMAIC[`${para.volume}|${para.portion}|${para.paragraph_number}`]||null;
  const ref=`${para.portion}, Paragraph ${para.paragraph_number}`;
  const id=`r-${para.volume}-${para.portion.replace(/\s/g,'_')}-${para.paragraph_number}`;
  return `<div class="para-row" id="${id}"><div class="para-row-header" onclick="toggleRow('${id}')"><span class="para-row-ref">${ref}</span><span class="para-row-toggle">▾</span></div><div class="para-row-preview" onclick="toggleRow('${id}')">${escHtml(para.english.substring(0,110))}...</div><div class="para-col para-col-english"><div class="para-col-label">English <button class="copy-btn" onclick="copyT(event,'${escBt(para.english)}')">Copy</button></div><div class="english-body">${fmtEnglish(para.english,q)}</div></div><div class="para-col"><div class="para-col-label">Aramaic ${araText?`<button class="copy-btn" onclick="copyT(event,'${escBt(araText)}')">Copy</button>`:''}</div><div class="aramaic-body">${araText?escHtml(araText):'<em style="color:#aaa;font-size:.85rem">Not available</em>'}</div></div></div>`;
}
function toggleRow(id){document.getElementById(id).classList.toggle('open');}
function goPage(p){browsePage=p;runBrowse();window.scrollTo({top:0,behavior:'smooth'});}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function sendChip(el){document.getElementById('chatInput').value=el.textContent;sendMessage();}
async function sendMessage(){
  if(isThinking)return;
  const input=document.getElementById('chatInput');
  const text=input.value.trim();
  if(!text)return;
  const welcome=document.getElementById('chatWelcome');
  if(welcome)welcome.remove();
  appendUserMsg(text);
  input.value='';input.style.height='auto';
  isThinking=true;document.getElementById('sendBtn').disabled=true;
  const thinkId=appendThinking();
  try{
    const resp=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-5',max_tokens:2500,system:buildSystemPrompt(),messages:[{role:'user',content:text}]})});
    removeThinking(thinkId);
    if(!resp.ok){const err=await resp.json();appendAssistantText(`Error: ${err.error?.message||'Something went wrong.'}`);return;}
    const data=await resp.json();
    renderTeaching(data.content[0]?.text||'');
  }catch(e){removeThinking(thinkId);appendAssistantText(`Connection error: ${e.message}`);}
  finally{isThinking=false;document.getElementById('sendBtn').disabled=false;}
}
function buildSystemPrompt(){
  const portions={};
  ENGLISH.forEach(p=>{const k=`Vol${p.volume}|${p.portion}`;if(!portions[k])portions[k]={min:p.paragraph_number,max:p.paragraph_number};else{portions[k].min=Math.min(portions[k].min,p.paragraph_number);portions[k].max=Math.max(portions[k].max,p.paragraph_number);}});
  const index=Object.entries(portions).map(([k,v])=>`${k} (§${v.min}–§${v.max})`).join('
');
  return `You are a Zohar teaching assistant. The application contains the full text of the Zohar, Volumes 1–16, with all English and Aramaic text embedded.

YOUR ONLY JOB: Find relevant paragraphs and return them using reference tags. The application replaces these tags with the actual verbatim text.

AVAILABLE PORTIONS:
${index}

REFERENCE TAG FORMAT (use exactly):
[ZOHAR:volume|portion|paragraph_number]
Example: [ZOHAR:2|Bereshit A|47]

STRICT RULES:
- NEVER write, quote, translate, or paraphrase any Zohar text yourself
- ONLY use [ZOHAR:] tags for all Zohar content
- Use "Kabbalists" not "Rabbis", "spiritual work" not "Torah study"
- When identifying a passage, refer to it as: [Portion Name], paragraph [N]

RESPONSE STRUCTURE:
1. Brief spiritual introduction (2-3 sentences, your own words)
2. [ZOHAR:] tags for 2-4 relevant paragraphs with brief connective commentary between them
3. A line starting with exactly: SUMMARY:
   Followed by 2-3 sentences summarizing the teaching
4. End with exactly: PRACTICAL: Would you like a practical application of this teaching — how to bring this wisdom into your daily life?`;
}
function renderTeaching(text){
  const container=document.getElementById('chatMessages');
  const msgEl=document.createElement('div');msgEl.className='msg assistant';
  const bubble=document.createElement('div');bubble.className='msg-bubble';
  const si=text.indexOf('SUMMARY:'),pi=text.indexOf('PRACTICAL:');
  let main=si>-1?text.substring(0,si):text,summary='',practical='';
  if(si>-1){const a=text.substring(si+8);const pi2=a.indexOf('PRACTICAL:');summary=pi2>-1?a.substring(0,pi2).trim():a.trim();}
  if(pi>-1)practical=text.substring(pi+10).trim();
  main.split(/(\[ZOHAR:[^\]]+\])/g).forEach(part=>{
    const m=part.match(/^\[ZOHAR:(\d+)\|([^|]+)\|(\d+)\]$/);
    if(m){bubble.appendChild(buildZoharBlock(+m[1],m[2],+m[3]));}
    else if(part.trim()){const p=document.createElement('p');p.className='ai-commentary';p.textContent=part.trim();bubble.appendChild(p);}
  });
  if(summary){const sd=document.createElement('div');sd.className='teaching-summary';sd.innerHTML=`<div class="teaching-summary-label">Summary</div><div class="teaching-summary-text">${escHtml(summary)}</div>${practical?`<div class="practical-prompt" onclick="askPractical()">${escHtml(practical)}</div>`:''}`;bubble.appendChild(sd);}
  msgEl.appendChild(bubble);container.appendChild(msgEl);container.scrollTop=container.scrollHeight;
}
function askPractical(){document.getElementById('chatInput').value='Yes, please give me a practical application.';sendMessage();}
function buildZoharBlock(vol,portion,paraNum){
  const eng=ENGLISH.find(p=>p.volume===vol&&p.portion===portion&&p.paragraph_number===paraNum);
  const araText=ARAMAIC[`${vol}|${portion}|${paraNum}`]||null;
  const block=document.createElement('div');block.className='zohar-block';
  if(!eng){block.innerHTML=`<div class="zohar-block-ref">Paragraph not found: ${portion}, §${paraNum}</div>`;return block;}
  block.innerHTML=`<div class="zohar-block-ref"><span>${portion}, Paragraph ${paraNum}</span><button class="copy-btn" onclick="copyT(event,'${escBt(eng.english)}')">Copy</button></div><div class="zohar-block-body"><div class="zohar-english-col">${fmtEnglish(eng.english,'')}</div><div class="zohar-aramaic-col">${araText?escHtml(araText):'<em style="color:#aaa;font-size:.85rem">Aramaic not available</em>'}</div></div>`;
  return block;
}
function appendUserMsg(t){const c=document.getElementById('chatMessages');const el=document.createElement('div');el.className='msg user';el.innerHTML=`<div class="msg-bubble">${escHtml(t)}</div>`;c.appendChild(el);c.scrollTop=c.scrollHeight;}
function appendAssistantText(t){const c=document.getElementById('chatMessages');const el=document.createElement('div');el.className='msg assistant';el.innerHTML=`<div class="msg-bubble"><p class="ai-commentary">${escHtml(t)}</p></div>`;c.appendChild(el);c.scrollTop=c.scrollHeight;}
function appendThinking(){const c=document.getElementById('chatMessages');const id='t'+Date.now();const el=document.createElement('div');el.id=id;el.className='msg assistant';el.innerHTML=`<div class="msg-bubble"><div class="thinking"><div class="thinking-dots"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div><span class="thinking-label">Searching the Zohar...</span></div></div>`;c.appendChild(el);c.scrollTop=c.scrollHeight;return id;}
function removeThinking(id){const el=document.getElementById(id);if(el)el.remove();}
function fmtEnglish(text,q){let h=escHtml(text);h=h.replace(/\b([A-Z]{2,}(?:\s+[A-Z']{2,}){1,}(?:\s+[A-Z]{1,})*)\b/g,'<span class="ashlag-text">$1</span>');if(q){const e=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');h=h.replace(new RegExp(`(${e})`,'gi'),'<mark>$1</mark>');}return h;}
function copyT(e,text){e.stopPropagation();navigator.clipboard.writeText(text);const b=e.target,o=b.textContent;b.textContent='✓';setTimeout(()=>b.textContent=o,1500);}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escBt(s){return String(s).replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/\$/g,'\\$').replace(/'/g,"\\'");}
buildNav();setMode('chat');
</script>
</body>
</html>